        public boolean allowOutgoingMessage(MessageOut messageOut, int id, InetAddress to)
        {
            try (DataOutputBuffer out = new DataOutputBuffer(1024))
            {
                InetAddressAndPort from = broadcastAddressAndPort();
                assert from.equals(lookupAddressAndPort.apply(messageOut.from));
                InetAddressAndPort toFull = lookupAddressAndPort.apply(to);
                int version = MessagingService.instance().getVersion(to);

                out.writeInt(MessagingService.PROTOCOL_MAGIC);
                out.writeInt(id);
                long timestamp = System.currentTimeMillis();
                out.writeInt((int) timestamp);
                messageOut.serialize(out, version);
                deliver.accept(toFull, new Message(messageOut.verb.ordinal(), out.toByteArray(), id, version, from));
            }
            catch (IOException e)
            {
                throw new RuntimeException(e);
            }
            return false;
        }

