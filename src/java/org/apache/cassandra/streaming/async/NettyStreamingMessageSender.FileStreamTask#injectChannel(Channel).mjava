        /**
         * For testing purposes
         */
        void injectChannel(Channel channel)
        {
            Thread currentThread = Thread.currentThread();
            if (threadLocalChannel.get(currentThread) != null)
                throw new IllegalStateException("previous channel already set");

            threadLocalChannel.put(currentThread, channel);
        }

