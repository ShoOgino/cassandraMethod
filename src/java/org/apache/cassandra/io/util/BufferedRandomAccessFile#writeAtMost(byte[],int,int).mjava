    /*
     * Write at most "length" bytes from "b" starting at position "offset", and
     * return the number of bytes written. caller is responsible for setting
     * isDirty.
     */
    private int writeAtMost(byte[] buff, int offset, int length) throws IOException
    {
        final int left = buffer.capacity() - buffer.position();
        if (current < bufferOffset || left < length)
            reBuffer();

        // logic is the following: we need to add bytes to the end of the buffer
        // starting from current buffer position and return this length
        length = Math.min(length, buffer.capacity() - buffer.position());

        buffer.put(buff, offset, length);
        current += length;

        if (current > bufferEnd)
            bufferEnd = current;

        return length;
    }

