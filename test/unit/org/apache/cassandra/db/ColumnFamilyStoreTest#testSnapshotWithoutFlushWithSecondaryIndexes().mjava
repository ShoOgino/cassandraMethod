    @Test
    public void testSnapshotWithoutFlushWithSecondaryIndexes() throws Exception
    {
        String keyspaceName = "Keyspace1";
        String cfName = "Indexed1";
        Keyspace keyspace = Keyspace.open(keyspaceName);
        ColumnFamilyStore cfs = keyspace.getColumnFamilyStore(cfName);
        cfs.truncateBlocking();

        List<Mutation> rms = new LinkedList<>();
        Mutation rm;

        rm = new Mutation(keyspaceName, ByteBufferUtil.bytes("k1"));
        rm.add(cfName, cellname("birthdate"), ByteBufferUtil.bytes(1L), 0);
        rm.add(cfName, cellname("nobirthdate"), ByteBufferUtil.bytes(1L), 0);
        rms.add(rm);
        Util.writeColumnFamily(rms);

        String snapshotName = "newSnapshot";
        cfs.snapshotWithoutFlush(snapshotName);

        File snapshotManifestFile = cfs.directories.getSnapshotManifestFile(snapshotName);
        JSONParser parser = new JSONParser();
        JSONObject manifest = (JSONObject) parser.parse(new FileReader(snapshotManifestFile));
        JSONArray files = (JSONArray) manifest.get("files");

        // Keyspace1-Indexed1 and the corresponding index CFS
        assert files.size() == 2;
    }

