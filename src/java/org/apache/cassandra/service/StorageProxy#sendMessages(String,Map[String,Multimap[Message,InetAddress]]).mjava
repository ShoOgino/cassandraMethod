    /**
     * for each datacenter, send a message to one node to relay the write to other replicas
     */
    private static void sendMessages(String localDataCenter, Map<String, Multimap<Message, InetAddress>> dcMessages)
    throws IOException
    {
        for (Map.Entry<String, Multimap<Message, InetAddress>> entry: dcMessages.entrySet())
        {
            String dataCenter = entry.getKey();

            // Grab a set of all the messages bound for this dataCenter and create an iterator over this set.
            Map<Message, Collection<InetAddress>> messagesForDataCenter = entry.getValue().asMap();

            for (Map.Entry<Message, Collection<InetAddress>> messages: messagesForDataCenter.entrySet())
            {
                Message message = messages.getKey();
                Iterator<InetAddress> iter = messages.getValue().iterator();
                assert iter.hasNext();

                // First endpoint in list is the destination for this group
                InetAddress target = iter.next();

                // Add all the other destinations that are bound for the same dataCenter as a header in the primary message.
                while (iter.hasNext())
                {
                    InetAddress destination = iter.next();

                    if (dataCenter.equals(localDataCenter))
                    {
                        // direct write to local DC
                        assert message.getHeader(RowMutation.FORWARD_HEADER) == null;
                        MessagingService.instance().sendOneWay(message, destination);
                    }
                    else
                    {
                        // group all nodes in this DC as forward headers on the primary message
                        ByteArrayOutputStream bos = new ByteArrayOutputStream();
                        DataOutputStream dos = new DataOutputStream(bos);

                        // append to older addresses
                        byte[] previousHints = message.getHeader(RowMutation.FORWARD_HEADER);
                        if (previousHints != null)
                            dos.write(previousHints);

                        dos.write(destination.getAddress());
                        message.setHeader(RowMutation.FORWARD_HEADER, bos.toByteArray());
                    }
                }
            
                MessagingService.instance().sendOneWay(message, target);
            }
        }
    }

