    private void firstMessageTest(NettyFactory.Mode mode, boolean compression) throws Exception
    {
        FirstHandshakeMessage before = new FirstHandshakeMessage(MessagingService.current_version, mode, compression);
        buf = before.encode(PooledByteBufAllocator.DEFAULT);
        FirstHandshakeMessage after = FirstHandshakeMessage.maybeDecode(buf);
        assertEquals(before, after);
        assertEquals(before.hashCode(), after.hashCode());
        Assert.assertFalse(before.equals(null));
    }

