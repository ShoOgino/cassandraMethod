    @Override
    public void write(StreamSession session, DataOutputStreamPlus out, int version) throws IOException
    {
        SSTableReader sstable = ref.get();
        CassandraStreamHeader.serializer.serialize(header, out, version);
        out.flush();

        CassandraStreamWriter writer = header.compressionInfo == null ?
                                       new CassandraStreamWriter(sstable, header.sections, session) :
                                       new CompressedCassandraStreamWriter(sstable, header.sections,
                                                                           header.compressionInfo, session);
        writer.write(out);
    }

