    private void registerMockMessaging(ICluster cluster)
    {
        BiConsumer<InetAddressAndPort, IMessage> deliverToInstance = (to, message) -> cluster.get(to).receiveMessage(message);
        BiConsumer<InetAddressAndPort, IMessage> deliverToInstanceIfNotFiltered = (to, message) -> {
            if (permitMessage(cluster, to, message))
                deliverToInstance.accept(to, message);
        };

        MessagingService.instance().outboundSink.add((message, to) -> {
            deliverToInstanceIfNotFiltered.accept(to, serializeMessage(message.from(), to, message));
            return false;
        });
    }

