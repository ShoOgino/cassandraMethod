    /**
     * Round up to the next multiple of 4k but no more than {@link #MAX_BUFFER_SIZE}.
     */
    default int roundBufferSize(long size)
    {
        if (size <= 0)
            return 4096;

        size = (size + 4095) & ~4095;
        return (int)Math.min(size, MAX_BUFFER_SIZE);
    }

