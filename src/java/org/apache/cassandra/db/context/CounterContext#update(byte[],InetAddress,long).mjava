    public byte[] update(byte[] context, InetAddress node, long delta)
    {
        // calculate node id
        byte[] nodeId = node.getAddress();

        // look for this node id
        for (int offset = 0; offset < context.length; offset += stepLength)
        {
            if (FBUtilities.compareByteSubArrays(nodeId, 0, context, offset, idLength) != 0)
                continue;

            // node id found: increment clock, update count; shift to front
            long clock = FBUtilities.byteArrayToLong(context, offset + idLength);
            long count = FBUtilities.byteArrayToLong(context, offset + idLength + clockLength);

            System.arraycopy(
                context,
                0,
                context,
                stepLength,
                offset);
            writeElement(context, nodeId, clock + 1L, count + delta);

            return context;
        }

        // node id not found: widen context
        byte[] previous = context;
        context = new byte[previous.length + stepLength];

        writeElement(context, nodeId, 1L, delta);
        System.arraycopy(
            previous,
            0,
            context,
            stepLength,
            previous.length);

        return context;
    }

