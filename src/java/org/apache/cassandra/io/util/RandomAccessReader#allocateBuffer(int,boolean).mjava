    protected ByteBuffer allocateBuffer(int bufferSize, boolean useDirectBuffer)
    {
        int size = (int) Math.min(fileLength, bufferSize);
        return useDirectBuffer
                ? ByteBuffer.allocate(size)
                : ByteBuffer.allocateDirect(size);
    }

