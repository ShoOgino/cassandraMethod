        /**
         * Wrapper that supplies accessors to the real implementations of the various dependencies for this method
         */
        private Multimap<InetAddressAndPort, FetchReplica> calculateRangesToFetchWithPreferredEndpoints(AbstractReplicationStrategy strategy, RangesAtEndpoint fetchRanges, String keyspace)
        {
            EndpointsByReplica preferredEndpoints =
            RangeStreamer.calculateRangesToFetchWithPreferredEndpoints((address, replicas) -> DatabaseDescriptor.getEndpointSnitch().sortedByProximity(address, replicas),
                                                                       strategy,
                                                                       fetchRanges,
                                                                       useStrictConsistency,
                                                                       tokenMetaClone,
                                                                       tokenMetaCloneAllSettled,
                                                                       RangeStreamer.ALIVE_PREDICATE,
                                                                       keyspace,
                                                                       Collections.emptyList());
            return RangeStreamer.convertPreferredEndpointsToWorkMap(preferredEndpoints);
        }

