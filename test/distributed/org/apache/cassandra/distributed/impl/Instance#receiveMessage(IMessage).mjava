    public void receiveMessage(IMessage imessage)
    {
        sync(() -> {
            // Based on org.apache.cassandra.net.IncomingTcpConnection.receiveMessage
            try (DataInputBuffer input = new DataInputBuffer(imessage.bytes()))
            {
                int version = imessage.version();
                if (version > MessagingService.current_version)
                {
                    throw new IllegalStateException(String.format("Node%d received message version %d but current version is %d",
                                                                  this.config.num(),
                                                                  version,
                                                                  MessagingService.current_version));
                }

                MessagingService.validateMagic(input.readInt());
                int id;
                if (version < MessagingService.VERSION_20)
                    id = Integer.parseInt(input.readUTF());
                else
                    id = input.readInt();
                long currentTime = ApproximateTime.currentTimeMillis();
                MessageIn message = MessageIn.read(input, version, id, MessageIn.readConstructionTime(imessage.from().address, input, currentTime));
                if (message == null)
                {
                    // callback expired; nothing to do
                    return;
                }
                if (version <= MessagingService.current_version)
                {
                    MessagingService.instance().receive(message, id);
                }
                // else ignore message
            }
            catch (Throwable t)
            {
                throw new RuntimeException("Exception occurred on node " + broadcastAddressAndPort(), t);
            }
        }).run();
    }

