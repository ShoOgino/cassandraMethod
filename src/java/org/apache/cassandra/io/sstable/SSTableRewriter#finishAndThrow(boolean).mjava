    @VisibleForTesting
    void finishAndThrow(boolean early)
    {
        List<Pair<SSTableReader, SSTableReader>> toReplace = new ArrayList<>();
        switchWriter(null);
        if (early)
            throw new RuntimeException("exception thrown early in finish");
        // make real sstables of the written ones:
        Iterator<Pair<SSTableWriter, SSTableReader>> it = finishedWriters.iterator();
        while(it.hasNext())
        {
            Pair<SSTableWriter, SSTableReader> w = it.next();
            if (w.left.getFilePointer() > 0)
            {
                SSTableReader newReader = w.left.closeAndOpenReader(maxAge);
                finished.add(newReader);

                if (w.right != null)
                {
                    w.right.sharesBfWith(newReader);
                    if (isOffline)
                    {
                        w.right.markObsolete();
                        w.right.releaseReference();
                    }
                }
                // w.right is the tmplink-reader we added when switching writer, replace with the real sstable.
                toReplace.add(Pair.create(w.right, newReader));
            }
            else
            {
                assert w.right == null;
                w.left.abort(true);
            }
            it.remove();
        }

        throw new RuntimeException("exception thrown after all sstables finished");
    }

