    @Test
    public void testSetLength() throws IOException
    {
        File tmpFile = File.createTempFile("set_length", "bin");
        BufferedRandomAccessFile file = new BufferedRandomAccessFile(tmpFile, "rw", 8*1024*1024);

        // test that data in buffer is truncated
        file.writeLong(1L);
        file.writeLong(2L);
        file.writeLong(3L);
        file.writeLong(4L);
        file.setLength(16L);
        assertSetLength(file, 16L);

        // seek back and truncate within file
        file.writeLong(3L);
        file.seek(8L);
        file.setLength(24L);
        assertSetLength(file, 24L);

        // seek back and truncate past end of file
        file.setLength(64L);
        assertSetLength(file, 64L);

        // make sure file is consistent after sync
        file.sync();
        assertSetLength(file, 64L);
    }

