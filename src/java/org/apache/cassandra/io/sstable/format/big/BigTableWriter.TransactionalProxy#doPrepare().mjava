        // finalise our state on disk, including renaming
        protected void doPrepare()
        {
            Map<MetadataType, MetadataComponent> metadataComponents = finalizeMetadata();

            iwriter.prepareToCommit();

            // write sstable statistics
            dataFile.setDescriptor(descriptor).prepareToCommit();
            writeMetadata(descriptor, metadataComponents);

            // save the table of components
            SSTable.appendTOC(descriptor, components);

            // rename to final
            rename(descriptor, components);

            if (openResult)
                finalReader = openFinal(descriptor.asType(Descriptor.Type.FINAL), SSTableReader.OpenReason.NORMAL);
        }

