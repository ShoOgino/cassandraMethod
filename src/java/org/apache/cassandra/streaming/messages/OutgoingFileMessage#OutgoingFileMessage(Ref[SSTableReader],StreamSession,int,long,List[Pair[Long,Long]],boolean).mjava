    public OutgoingFileMessage(Ref<SSTableReader> ref, StreamSession session, int sequenceNumber, long estimatedKeys, List<Pair<Long, Long>> sections, boolean keepSSTableLevel)
    {
        super(Type.FILE);
        this.ref = ref;

        SSTableReader sstable = ref.get();
        filename = sstable.getFilename();
        this.header = new FileMessageHeader(sstable.metadata().id,
                                            FBUtilities.getBroadcastAddressAndPort(),
                                            session.planId(),
                                            session.sessionIndex(),
                                            sequenceNumber,
                                            sstable.descriptor.version,
                                            sstable.descriptor.formatType,
                                            estimatedKeys,
                                            sections,
                                            sstable.compression ? sstable.getCompressionMetadata() : null,
                                            sstable.getRepairedAt(),
                                            sstable.getPendingRepair(),
                                            keepSSTableLevel ? sstable.getSSTableLevel() : 0,
                                            sstable.header.toComponent());
    }

