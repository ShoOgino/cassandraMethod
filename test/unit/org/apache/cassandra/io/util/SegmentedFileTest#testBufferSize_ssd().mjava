    @Test
    public void testBufferSize_ssd()
    {
        DatabaseDescriptor.setDiskOptimizationStrategy(Config.DiskOptimizationStrategy.ssd);
        DatabaseDescriptor.setDiskOptimizationPageCrossChance(0.1);

        assertEquals(4096, SegmentedFile.Builder.bufferSize(0));
        assertEquals(4096, SegmentedFile.Builder.bufferSize(10));
        assertEquals(4096, SegmentedFile.Builder.bufferSize(100));
        assertEquals(4096, SegmentedFile.Builder.bufferSize(4096));
        assertEquals(8192, SegmentedFile.Builder.bufferSize(4505));   // just < (4096 + 4096 * 0.1)
        assertEquals(12288, SegmentedFile.Builder.bufferSize(4506));  // just > (4096 + 4096 * 0.1)

        DatabaseDescriptor.setDiskOptimizationPageCrossChance(0.5);
        assertEquals(8192, SegmentedFile.Builder.bufferSize(4506));  // just > (4096 + 4096 * 0.1)
        assertEquals(8192, SegmentedFile.Builder.bufferSize(6143));  // < (4096 + 4096 * 0.5)
        assertEquals(12288, SegmentedFile.Builder.bufferSize(6144));  // = (4096 + 4096 * 0.5)
        assertEquals(12288, SegmentedFile.Builder.bufferSize(6145));  // > (4096 + 4096 * 0.5)

        DatabaseDescriptor.setDiskOptimizationPageCrossChance(1.0); // never add a page
        assertEquals(8192, SegmentedFile.Builder.bufferSize(8191));
        assertEquals(8192, SegmentedFile.Builder.bufferSize(8192));

        DatabaseDescriptor.setDiskOptimizationPageCrossChance(0.0); // always add a page
        assertEquals(8192, SegmentedFile.Builder.bufferSize(10));
        assertEquals(8192, SegmentedFile.Builder.bufferSize(4096));
    }

