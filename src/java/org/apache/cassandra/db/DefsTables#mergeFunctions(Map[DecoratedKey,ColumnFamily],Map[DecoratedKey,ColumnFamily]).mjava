    private static void mergeFunctions(Map<DecoratedKey, ColumnFamily> old, Map<DecoratedKey, ColumnFamily> updated)
    {
        MapDifference<DecoratedKey, ColumnFamily> diff = Maps.difference(old, updated);

        // New namespace with functions
        for (Map.Entry<DecoratedKey, ColumnFamily> entry : diff.entriesOnlyOnRight().entrySet())
        {
            ColumnFamily cfFunctions = entry.getValue();
            if (!cfFunctions.hasColumns())
                continue;

            for (UFMetaData uf : UFMetaData.fromSchema(new Row(entry.getKey(), cfFunctions)).values())
                addFunction(uf);
        }

        for (Map.Entry<DecoratedKey, MapDifference.ValueDifference<ColumnFamily>> modifiedEntry : diff.entriesDiffering().entrySet())
        {
            DecoratedKey namespace = modifiedEntry.getKey();
            ColumnFamily prevCFFunctions = modifiedEntry.getValue().leftValue(); // state before external modification
            ColumnFamily newCFFunctions = modifiedEntry.getValue().rightValue(); // updated state

            if (!prevCFFunctions.hasColumns()) // whole namespace was deleted and now it's re-created
            {
                for (UFMetaData uf : UFMetaData.fromSchema(new Row(namespace, newCFFunctions)).values())
                    addFunction(uf);
            }
            else if (!newCFFunctions.hasColumns()) // whole namespace is deleted
            {
                for (UFMetaData uf : UFMetaData.fromSchema(new Row(namespace, prevCFFunctions)).values())
                    dropFunction(uf);
            }
            else // has modifications in the functions, need to perform nested diff to determine what was really changed
            {
                MapDifference<String, UFMetaData> functionsDiff = Maps.difference(UFMetaData.fromSchema(new Row(namespace, prevCFFunctions)),
                    UFMetaData.fromSchema(new Row(namespace, newCFFunctions)));

                for (UFMetaData function : functionsDiff.entriesOnlyOnRight().values())
                    addFunction(function);

                for (UFMetaData function : functionsDiff.entriesOnlyOnLeft().values())
                    dropFunction(function);

                for (MapDifference.ValueDifference<UFMetaData> tdiff : functionsDiff.entriesDiffering().values())
                    updateFunction(tdiff.rightValue()); // use the most recent value
            }
        }
    }

