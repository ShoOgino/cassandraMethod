        public RowMutation deserialize(DataInput dis, int version, IColumnSerializer.Flag flag) throws IOException
        {
            String table = dis.readUTF();
            ByteBuffer key = ByteBufferUtil.readWithShortLength(dis);
            Map<UUID, ColumnFamily> modifications = new HashMap<UUID, ColumnFamily>();
            int size = dis.readInt();
            for (int i = 0; i < size; ++i)
            {
                // We used to uselessly write the cf id here
                if (version < MessagingService.VERSION_12)
                    ColumnFamily.serializer.deserializeCfId(dis, version);
                ColumnFamily cf = ColumnFamily.serializer.deserialize(dis, flag, TreeMapBackedSortedColumns.factory(), version);
                // We don't allow RowMutation with null column family, so we should never get null back.
                assert cf != null;
                modifications.put(cf.id(), cf);
            }
            return new RowMutation(table, key, modifications);
        }

