        public void add(Replica replica, Conflict ignoreConflict)
        {
            if (hasSnapshot) throw new IllegalStateException();
            Preconditions.checkNotNull(replica);
            if (!Objects.equals(super.endpoint, replica.endpoint()))
                throw new IllegalArgumentException("Replica " + replica + " has incorrect endpoint (expected " + super.endpoint + ")");

            Replica prev = super.byRange.put(replica.range(), replica);
            if (prev != null)
            {
                super.byRange.put(replica.range(), prev); // restore prev
                switch (ignoreConflict)
                {
                    case DUPLICATE:
                        if (prev.equals(replica))
                            break;
                    case NONE:
                        throw new IllegalArgumentException("Conflicting replica added (expected unique ranges): " + replica + "; existing: " + prev);
                    case ALL:
                }
                return;
            }

            list.add(replica);
        }

