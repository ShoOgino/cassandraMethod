    public static void indexRow(DecoratedKey<?> key, ColumnFamilyStore cfs, SortedSet<ByteBuffer> indexedColumns)
    {
        logger.debug("Indexing row {} ", key);
        Set<SecondaryIndex> indexesToFlush = Collections.emptySet();
        switchLock.readLock().lock();
        try
        {
            synchronized (cfs.table.indexLockFor(key.key))
            {
                ColumnFamily cf = readCurrentIndexedColumns(key, cfs, indexedColumns);
                if (cf != null)
                    indexesToFlush = cfs.indexManager.applyIndexUpdates(key.key, cf, cf.getColumnNames(), null);
            }
        }
        finally
        {
            switchLock.readLock().unlock();
        }

        // during index build, we do flush index memtables separately from master; otherwise we could OOM
        for (SecondaryIndex index : indexesToFlush)
            index.maybeFlush();
    }

