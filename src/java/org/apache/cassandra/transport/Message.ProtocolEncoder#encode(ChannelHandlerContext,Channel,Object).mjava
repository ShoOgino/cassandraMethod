        public Object encode(ChannelHandlerContext ctx, Channel channel, Object msg)
        {
            assert msg instanceof Message : "Expecting message, got " + msg;

            Message message = (Message)msg;

            Connection connection = (Connection)channel.getAttachment();
            // The only case the connection can be null is when we send the initial STARTUP message (client side thus)
            int version = connection == null ? Frame.Header.CURRENT_VERSION : connection.getVersion();

            ChannelBuffer body = message.encode(version);
            EnumSet<Frame.Header.Flag> flags = EnumSet.noneOf(Frame.Header.Flag.class);
            if (message instanceof Response)
            {
                UUID tracingId = ((Response)message).getTracingId();
                if (tracingId != null)
                {
                    body = ChannelBuffers.wrappedBuffer(CBUtil.uuidToCB(tracingId), body);
                    flags.add(Frame.Header.Flag.TRACING);
                }
            }
            else
            {
                assert message instanceof Request;
                if (((Request)message).isTracingRequested())
                    flags.add(Frame.Header.Flag.TRACING);
            }

            return Frame.create(message.type, message.getStreamId(), version, flags, body);
        }

