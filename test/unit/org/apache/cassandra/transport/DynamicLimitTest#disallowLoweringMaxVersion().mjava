    @Test
    public void disallowLoweringMaxVersion() throws Throwable
    {
        // Lowering the max version once connections have been established is a problem
        // for some clients. So for a dynamic limit, if notifications of peer versions
        // trigger a change to the max version, it's only allowed to increase the max
        // negotiable version

        InetAddress peer = null;
        try
        {
            // ensure that no static limit is configured
            setStaticLimitInConfig(null);
            ConfiguredLimit limit = ConfiguredLimit.newLimit();
            assertEquals(Server.CURRENT_VERSION, limit.getMaxVersion());

            peer = setupPeer("127.1.0.1", "3.0.0");
            limit.updateMaxSupportedVersion();
            assertEquals(Server.CURRENT_VERSION, limit.getMaxVersion());

            // learn that peer doesn't actually fully support V4, behaviour should remain the same
            updatePeerInfo(peer, "2.2.0");
            limit.updateMaxSupportedVersion();
            assertEquals(Server.CURRENT_VERSION, limit.getMaxVersion());

            // finally learn that peer2 has been upgraded, just for completeness
            updatePeerInfo(peer, "3.3.0");
            limit.updateMaxSupportedVersion();
            assertEquals(Server.CURRENT_VERSION, limit.getMaxVersion());

        } finally {
            cleanupPeers(peer);
        }
    }

