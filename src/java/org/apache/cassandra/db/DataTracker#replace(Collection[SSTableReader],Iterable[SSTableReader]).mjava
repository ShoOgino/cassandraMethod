    private void replace(Collection<SSTableReader> oldSSTables, Iterable<SSTableReader> replacements)
    {
        // removing sstables that are not marked compacting is a bug, since that means we could
        // race with a compaction check
        for (SSTableReader sstable : oldSSTables)
            assert view.get().compacting.contains(sstable);

        if (!cfstore.isValid())
        {
            removeOldSSTablesSize(replacements);
            replacements = Collections.emptyList();
        }

        View currentView, newView;
        do
        {
            currentView = view.get();
            newView = currentView.replace(oldSSTables, replacements);
        }
        while (!view.compareAndSet(currentView, newView));

        postReplace(oldSSTables, replacements);
    }

