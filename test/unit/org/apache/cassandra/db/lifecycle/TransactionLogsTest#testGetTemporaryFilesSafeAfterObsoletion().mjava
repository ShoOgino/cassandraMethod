    @Test
    public void testGetTemporaryFilesSafeAfterObsoletion() throws Throwable
    {
        ColumnFamilyStore cfs = MockSchema.newCFS(KEYSPACE);
        SSTableReader sstable = sstable(cfs, 0, 128);
        File dataFolder = sstable.descriptor.directory;

        TransactionLogs transactionLogs = new TransactionLogs(OperationType.COMPACTION, cfs.metadata);
        assertNotNull(transactionLogs);

        TransactionLogs.SSTableTidier tidier = transactionLogs.obsoleted(sstable);

        transactionLogs.finish();
        sstable.markObsolete(tidier);
        sstable.selfRef().release();

        for (int i = 0; i < 1000; i++)
        {
            // This should race with the asynchronous deletion of txn log files
            // It doesn't matter what it returns but it should not throw
            TransactionLogs.getTemporaryFiles(cfs.metadata, dataFolder);
        }
    }

