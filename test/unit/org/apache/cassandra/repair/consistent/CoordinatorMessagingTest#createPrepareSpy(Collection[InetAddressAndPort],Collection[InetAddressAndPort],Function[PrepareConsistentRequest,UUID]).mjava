    private MockMessagingSpy createPrepareSpy(Collection<InetAddressAndPort> failed,
                                              Collection<InetAddressAndPort> timeout,
                                              Function<PrepareConsistentRequest, UUID> sessionIdFunc)
    {
        return MockMessagingService.when(
        all(verb(Verb.REPAIR_REQ),
            payload((p) -> p instanceof PrepareConsistentRequest))
        ).respond((msgOut, to) ->
                  {
                      if(timeout.contains(to)) return null;
                      else return Message.out(Verb.REPAIR_REQ, new PrepareConsistentResponse(sessionIdFunc.apply((PrepareConsistentRequest) msgOut.payload), to, !failed.contains(to)));
                  });
    }

