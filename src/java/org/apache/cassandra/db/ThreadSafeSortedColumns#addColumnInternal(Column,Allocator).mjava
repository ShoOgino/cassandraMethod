    private long addColumnInternal(Column column, Allocator allocator)
    {
        ByteBuffer name = column.name();
        while (true)
        {
            Column oldColumn = map.putIfAbsent(name, column);
            if (oldColumn == null)
                return column.dataSize();

            // calculate reconciled col from old (existing) col and new col
            Column reconciledColumn = column.reconcile(oldColumn, allocator);
            if (map.replace(name, oldColumn, reconciledColumn))
                return reconciledColumn.dataSize() - oldColumn.dataSize();

            // We failed to replace column due to a concurrent update or a concurrent removal. Keep trying.
            // (Currently, concurrent removal should not happen (only updates), but let us support that anyway.)
        }
    }

