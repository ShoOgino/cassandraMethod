    public void receiveMessage(IMessage imessage)
    {
        sync(() -> {
            // Based on org.apache.cassandra.net.IncomingTcpConnection.receiveMessage
            try (DataInputBuffer input = new DataInputBuffer(imessage.bytes()))
            {
                int version = imessage.version();

                MessagingService.validateMagic(input.readInt());
                int id;
                if (version < MessagingService.VERSION_20)
                    id = Integer.parseInt(input.readUTF());
                else
                    id = input.readInt();

                long timestamp = System.currentTimeMillis();
                boolean isCrossNodeTimestamp = false;
                // make sure to readInt, even if cross_node_to is not enabled
                int partial = input.readInt();
                if (DatabaseDescriptor.hasCrossNodeTimeout())
                {
                    long crossNodeTimestamp = (timestamp & 0xFFFFFFFF00000000L) | (((partial & 0xFFFFFFFFL) << 2) >> 2);
                    isCrossNodeTimestamp = (timestamp != crossNodeTimestamp);
                    timestamp = crossNodeTimestamp;
                }

                MessageIn message = MessageIn.read(input, version, id);
                if (message == null)
                {
                    // callback expired; nothing to do
                    return;
                }
                if (version <= MessagingService.current_version)
                {
                    MessagingService.instance().receive(message, id, timestamp, isCrossNodeTimestamp);
                }
                // else ignore message
            }
            catch (Throwable t)
            {
                throw new RuntimeException("Exception occurred on node " + broadcastAddressAndPort(), t);
            }
        }).run();
    }

