    @Test
    public void failHandshake_AlreadyConnected()
    {
        ChannelPromise future = channel.newPromise();
        handler.setHandshakeTimeout(future);
        Assert.assertFalse(future.isCancelled());
        Assert.assertTrue(channel.isOpen());
        handler.setState(State.MESSAGING_HANDSHAKE_COMPLETE);
        handler.failHandshake(channel.pipeline().firstContext());
        Assert.assertSame(State.MESSAGING_HANDSHAKE_COMPLETE, handler.getState());
        Assert.assertTrue(channel.isOpen());
    }

