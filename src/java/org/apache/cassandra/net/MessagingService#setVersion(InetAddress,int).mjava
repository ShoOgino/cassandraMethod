    /**
     * @return the last version associated with address, or @param version if this is the first such version
     */
    public int setVersion(InetAddress endpoint, int version)
    {
        logger.trace("Setting version {} for {}", version, endpoint);

        if (version < VERSION_22)
            allNodesAtLeast22 = false;

        Integer v = versions.put(endpoint, version);

        // if the version was increased to 2.2 or later, see if all nodes are >= 2.2 now
        if (v != null && v < VERSION_22 && version >= VERSION_22)
            refreshAllNodesAtLeast22();

        return v == null ? version : v;
    }

