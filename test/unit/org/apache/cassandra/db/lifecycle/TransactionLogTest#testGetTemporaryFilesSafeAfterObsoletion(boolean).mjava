    private void testGetTemporaryFilesSafeAfterObsoletion(boolean finishBefore) throws Throwable
    {
        ColumnFamilyStore cfs = MockSchema.newCFS(KEYSPACE);
        SSTableReader sstable = sstable(cfs, 0, 128);
        File dataFolder = sstable.descriptor.directory;

        TransactionLog transactionLogs = new TransactionLog(OperationType.COMPACTION, cfs.metadata);
        assertNotNull(transactionLogs);

        TransactionLog.SSTableTidier tidier = transactionLogs.obsoleted(sstable);

        if (finishBefore)
            transactionLogs.finish();

        sstable.markObsolete(tidier);
        sstable.selfRef().release();

        for (int i = 0; i < 100; i++)
        {
            // This should race with the asynchronous deletion of txn log files
            // It doesn't matter what it returns but it should not throw
            TransactionLog.getTemporaryFiles(cfs.metadata, dataFolder);
        }

        if (!finishBefore)
            transactionLogs.finish();
    }

