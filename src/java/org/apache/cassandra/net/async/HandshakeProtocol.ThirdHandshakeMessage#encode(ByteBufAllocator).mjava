        @SuppressWarnings("resource")
        public ByteBuf encode(ByteBufAllocator allocator)
        {
            int bufLength = Integer.BYTES + CompactEndpointSerializationHelper.serializedSize(address);
            ByteBuf buffer = allocator.directBuffer(bufLength, bufLength);
            buffer.writerIndex(0);
            buffer.writeInt(messagingVersion);
            try
            {
                DataOutput bbos = new ByteBufOutputStream(buffer);
                CompactEndpointSerializationHelper.serialize(address, bbos);
                return buffer;
            }
            catch (IOException e)
            {
                // Shouldn't happen, we're serializing in memory.
                throw new AssertionError(e);
            }
        }

