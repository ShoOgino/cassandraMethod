    private int serialize(int messagingVersion, BaseMessageInHandler handler) throws Exception
    {
        buf.resetReaderIndex();
        buf.resetWriterIndex();
        buf.writeInt(MessagingService.PROTOCOL_MAGIC);
        buf.writeInt(42); // this is the id
        buf.writeInt((int) NanoTimeToCurrentTimeMillis.convert(System.nanoTime()));

        msgOut.serialize(new ByteBufDataOutputPlus(buf), messagingVersion);
        handler.decode(null, buf, Collections.emptyList());
        return msgOut.serializedSize(messagingVersion);
    }

