    @VisibleForTesting
    public OutboundMessagingConnection getConnection(MessageOut msg)
    {
        if (msg.connectionType == null)
        {
            // optimize for the common path (the small message channel)
            if (Stage.GOSSIP != msg.getStage())
            {
                return msg.serializedSize(smallMessageChannel.getTargetVersion()) < LARGE_MESSAGE_THRESHOLD
                       ? smallMessageChannel
                       : largeMessageChannel;
            }
            return gossipChannel;
        }
        else
        {
            return getConnection(msg.connectionType);
        }
    }

