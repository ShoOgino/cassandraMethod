    @Test
    public void write_Coalescing_ScheduleFlushTask()
    {
        CoalescingChannelWriter channelWriter = resetEnvForCoalescing(DatabaseDescriptor.getOtcCoalescingEnoughCoalescedMessages());

        Assert.assertTrue(channel.unsafe().outboundBuffer().totalPendingWriteBytes() == 0);
        Assert.assertFalse(channelWriter.scheduledFlush.get());
        Assert.assertTrue(channelWriter.write(new QueuedMessage(new MessageOut<>(ECHO), 42), true));

        Assert.assertTrue(channelWriter.scheduledFlush.get());
        Assert.assertTrue(channel.unsafe().outboundBuffer().totalPendingWriteBytes() > 0);
        Assert.assertTrue(channelWriter.scheduledFlush.get());

        // this unfortunately know a little too much about how the sausage is made in CoalescingChannelWriter :-/
        channel.runScheduledPendingTasks();
        channel.runPendingTasks();
        Assert.assertTrue(channel.unsafe().outboundBuffer().totalPendingWriteBytes() == 0);
        Assert.assertFalse(channelWriter.scheduledFlush.get());
        Assert.assertTrue(channel.releaseOutbound());
    }

