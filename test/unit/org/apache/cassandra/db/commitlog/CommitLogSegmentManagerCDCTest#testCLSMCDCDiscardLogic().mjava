    @Test
    public void testCLSMCDCDiscardLogic() throws Throwable
    {
        CommitLogSegmentManagerCDC cdcMgr = (CommitLogSegmentManagerCDC)CommitLog.instance.segmentManager;

        createTable("CREATE TABLE %s (idx int, data text, primary key(idx)) WITH cdc=false;");
        for (int i = 0; i < 8; i++)
        {
            new RowUpdateBuilder(currentTableMetadata(), 0, i)
                .add("data", randomizeBuffer(DatabaseDescriptor.getCommitLogSegmentSize() / 4)) // fit 3 in a segment
                .build().apply();
        }

        // Should have 4 segments CDC since we haven't flushed yet, 3 PERMITTED, one of which is active, and 1 PERMITTED, in waiting
        Assert.assertEquals(4 * DatabaseDescriptor.getCommitLogSegmentSize(), cdcMgr.updateCDCTotalSize());
        expectCurrentCDCState(CDCState.PERMITTED);
        CommitLog.instance.forceRecycleAllSegments();

        // on flush, these PERMITTED should be deleted
        Assert.assertEquals(0, new File(DatabaseDescriptor.getCDCLogLocation()).listFiles().length);

        createTable("CREATE TABLE %s (idx int, data text, primary key(idx)) WITH cdc=true;");
        for (int i = 0; i < 8; i++)
        {
            new RowUpdateBuilder(currentTableMetadata(), 0, i)
                .add("data", randomizeBuffer(DatabaseDescriptor.getCommitLogSegmentSize() / 4))
                .build().apply();
        }
        // 4 total again, 3 CONTAINS, 1 in waiting PERMITTED
        Assert.assertEquals(4 * DatabaseDescriptor.getCommitLogSegmentSize(), cdcMgr.updateCDCTotalSize());
        CommitLog.instance.forceRecycleAllSegments();
        expectCurrentCDCState(CDCState.PERMITTED);

        // On flush, PERMITTED is deleted, CONTAINS is preserved.
        cdcMgr.awaitManagementTasksCompletion();
        int seen = getCDCRawCount();
        Assert.assertTrue("Expected >3 files in cdc_raw, saw: " + seen, seen >= 3);
    }

