    /** Serialize a collection of tokens to bytes */
    private static ByteBuffer serializeTokens(Collection<Token> tokens)
    {
        // Guesstimate the total number of bytes needed
        int estCapacity = (tokens.size() * 16) + (tokens.size() * 2);
        ByteBuffer toks = ByteBuffer.allocate(estCapacity);
        IPartitioner p = StorageService.getPartitioner();

        for (Token token : tokens)
        {
            ByteBuffer tokenBytes = p.getTokenFactory().toByteArray(token);

            // If we blow the buffer, grow it by double
            if (toks.remaining() < (2 + tokenBytes.remaining()))
            {
                estCapacity = estCapacity * 2;
                ByteBuffer newToks = ByteBuffer.allocate(estCapacity);
                toks.flip();
                newToks.put(toks);
                toks = newToks;
            }

            toks.putShort((short)tokenBytes.remaining());
            toks.put(tokenBytes);
        }

        toks.flip();
        return toks;
    }

