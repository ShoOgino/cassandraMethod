    private MockMessagingSpy createPrepareSpy(Collection<InetAddressAndPort> failed,
                                              Collection<InetAddressAndPort> timeout,
                                              Function<PrepareConsistentRequest, UUID> sessionIdFunc)
    {
        return MockMessagingService.when(
        all(verb(MessagingService.Verb.REPAIR_MESSAGE),
            payload((p) -> p instanceof PrepareConsistentRequest))
        ).respond((msgOut, to) ->
                  {
                      if(timeout.contains(to)) return null;
                      else return MessageIn.create(to,
                                                   new PrepareConsistentResponse(sessionIdFunc.apply((PrepareConsistentRequest) msgOut.payload), to, !failed.contains(to)),
                                                   Collections.emptyMap(),
                                                   MessagingService.Verb.REPAIR_MESSAGE,
                                                   MessagingService.current_version);
                  });
    }

