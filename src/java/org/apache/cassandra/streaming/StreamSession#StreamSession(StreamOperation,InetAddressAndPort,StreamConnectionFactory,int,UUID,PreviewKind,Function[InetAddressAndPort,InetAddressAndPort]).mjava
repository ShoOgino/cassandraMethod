    @VisibleForTesting
    public StreamSession(StreamOperation streamOperation, InetAddressAndPort peer, StreamConnectionFactory factory,
                         int index, UUID pendingRepair, PreviewKind previewKind,
                         Function<InetAddressAndPort, InetAddressAndPort> preferredIpMapper)
    {
        this.streamOperation = streamOperation;
        this.peer = peer;
        this.index = index;
        InetAddressAndPort preferredPeerEndpoint = preferredIpMapper.apply(peer);
        this.preferredPeerInetAddressAndPort = (preferredPeerEndpoint == null) ? peer : preferredPeerEndpoint;

        OutboundConnectionIdentifier id = OutboundConnectionIdentifier.stream(InetAddressAndPort.getByAddressOverrideDefaults(FBUtilities.getJustLocalAddress(), 0),
                                                                              preferredPeerInetAddressAndPort);

        this.messageSender = new NettyStreamingMessageSender(this, id, factory, StreamMessage.CURRENT_VERSION, previewKind.isPreview());
        this.metrics = StreamingMetrics.get(preferredPeerInetAddressAndPort);
        this.pendingRepair = pendingRepair;
        this.previewKind = previewKind;

        logger.debug("Creating stream session peer={} preferredPeerInetAddressAndPort={}", peer, preferredPeerInetAddressAndPort);
    }

