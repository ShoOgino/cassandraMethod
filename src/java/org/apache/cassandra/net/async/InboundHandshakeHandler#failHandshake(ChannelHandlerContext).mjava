    @VisibleForTesting
    void failHandshake(ChannelHandlerContext ctx)
    {
        // we're not really racing on the handshakeTimeout as we're in the event loop,
        // but, hey, defensive programming is beautiful thing!
        if (state == State.HANDSHAKE_COMPLETE || (handshakeTimeout != null && handshakeTimeout.isCancelled()))
            return;

        state = State.HANDSHAKE_FAIL;
        ctx.close();

        if (handshakeTimeout != null)
        {
            handshakeTimeout.cancel(false);
            handshakeTimeout = null;
        }
    }

