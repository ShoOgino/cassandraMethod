    @Test
    public void testIndexInsertAndUpdate()
    {
        int nowInSec = FBUtilities.nowInSeconds();

        // create a row then test that the configured index instance was able to read the row
        CFMetaData cfm = Schema.instance.getCFMetaData(KEYSPACE1, CF_INDEXED);
        ColumnDefinition cdef = cfm.getColumnDefinition(new ColumnIdentifier("indexed", true));

        RowUpdateBuilder builder = new RowUpdateBuilder(cfm, FBUtilities.timestampMicros(), "k1");
        builder.add("indexed", ByteBufferUtil.bytes("foo"));
        builder.build().apply();


        UnfilteredRowIterator indexedRow = PerRowSecondaryIndexTest.TestIndex.LAST_INDEXED_PARTITION;
        assertNotNull(indexedRow);
        assertEquals(ByteBufferUtil.bytes("foo"), UnfilteredRowIterators.filter(indexedRow, nowInSec).next().getCell(cdef).value());

        // update the row and verify what was indexed
        builder = new RowUpdateBuilder(cfm, FBUtilities.timestampMicros() + 1 , "k1");
        builder.add("indexed", ByteBufferUtil.bytes("bar"));
        builder.build().apply();

        indexedRow = PerRowSecondaryIndexTest.TestIndex.LAST_INDEXED_PARTITION;
        assertNotNull(indexedRow);
        assertEquals(ByteBufferUtil.bytes("bar"), UnfilteredRowIterators.filter(indexedRow, nowInSec).next().getCell(cdef).value());
        assertTrue(Arrays.equals("k1".getBytes(), PerRowSecondaryIndexTest.TestIndex.LAST_INDEXED_KEY.array()));
    }

