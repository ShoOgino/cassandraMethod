    /**
     * Stream the given ranges to the target endpoint from each of the given CFs.
    */
    public static void transferRanges(StreamOutSession session,
                                      Iterable<ColumnFamilyStore> cfses,
                                      Collection<Range<Token>> ranges,
                                      OperationType type,
                                      boolean flushTables)
    {
        assert ranges.size() > 0;

        List<Range<Token>> normalizedRanges = Range.normalize(ranges);

        logger.info("Beginning transfer to {}", session.getHost());
        logger.debug("Ranges are {}", StringUtils.join(normalizedRanges, ","));

        if (flushTables)
            flushSSTables(cfses);

        List<SSTableReader> sstables = Lists.newLinkedList();
        for (ColumnFamilyStore cfStore : cfses)
        {
            List<AbstractBounds<RowPosition>> rowBoundsList = Lists.newLinkedList();
            for (Range<Token> range : normalizedRanges)
                rowBoundsList.add(range.toRowBounds());
            ColumnFamilyStore.ViewFragment view = cfStore.markReferenced(rowBoundsList);
            sstables.addAll(view.sstables);
        }

        transferSSTables(session, sstables, normalizedRanges, type);
    }

