        public Object decode(ChannelHandlerContext ctx, Channel channel, Object msg)
        throws IOException
        {
            assert msg instanceof Frame : "Expecting frame, got " + msg;

            Frame frame = (Frame)msg;
            Connection connection = (Connection)channel.getAttachment();

            if (!frame.header.flags.contains(Header.Flag.COMPRESSED) || connection == null)
                return frame;

            FrameCompressor compressor = connection.getCompressor();
            if (compressor == null)
                return frame;

            return compressor.decompress(frame);
        }

