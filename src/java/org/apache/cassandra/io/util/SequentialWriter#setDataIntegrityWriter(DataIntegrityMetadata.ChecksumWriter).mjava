    /**
     * Turn on digest computation on this writer.
     * This can only be called before any data is written to this write,
     * otherwise an IllegalStateException is thrown.
     */
    public void setDataIntegrityWriter(DataIntegrityMetadata.ChecksumWriter writer)
    {
        if (current != 0)
            throw new IllegalStateException();
        metadata = writer;
        metadata.writeChunkSize(buffer.length);
    }

