    @VisibleForTesting
    void setupMessagingPipeline(ChannelPipeline pipeline, InetAddressAndPort peer, boolean compressed, int messagingVersion)
    {
        if (compressed)
            pipeline.addLast(NettyFactory.INBOUND_COMPRESSOR_HANDLER_NAME, NettyFactory.createLz4Decoder(messagingVersion));

        BaseMessageInHandler messageInHandler = messagingVersion >= MessagingService.VERSION_40
                                                ? new MessageInHandler(peer, messagingVersion)
                                                : new MessageInHandlerPre40(peer, messagingVersion);

        pipeline.addLast("messageInHandler", messageInHandler);
        pipeline.remove(this);
    }

