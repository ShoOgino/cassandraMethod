    public synchronized Message getMessage(int version) throws IOException
    {
        Message msg = messages.get(version);
        if (msg == null)
        {
            msg = prod.getMessage(version);
            if (messageId == null)
                messageId = msg.getMessageId();
            // it is important that both messages have the same id for callback processing.
            msg.setId(messageId);
            messages.put(version, msg);
        }
        return msg;
    }

