    @Test
    public void test() throws Exception
    {
        FileCountingStreamEventHandler streamEventHandler = new FileCountingStreamEventHandler();
        StreamSession session = setupStreamingSessionForTest(streamEventHandler);
        Collection<OutgoingStream> outgoingStreams = store.getStreamManager().createOutgoingStreams(session,
                                                                                                    rangesAtEndpoint,
                                                                                                    NO_PENDING_REPAIR,
                                                                                                    PreviewKind.NONE);

        session.addTransferStreams(outgoingStreams);
        DataOutputStreamPlus out = constructDataOutputStream();

        for (OutgoingStream outgoingStream : outgoingStreams)
            outgoingStream.write(session, out, MessagingService.VERSION_40);

        int totalNumberOfFiles = session.transfers.get(store.metadata.id).getTotalNumberOfFiles();

        assertEquals(CassandraOutgoingFile.getComponentManifest(sstable).components().size(), totalNumberOfFiles);
        assertEquals(streamEventHandler.fileNames.size(), totalNumberOfFiles);
    }

