    @Test
    public void testUpdateDigest() throws Exception
    {
        ColumnFamilyStore cfs = Keyspace.open(KEYSPACE1).getColumnFamilyStore(COUNTER1);
        ByteBuffer col = ByteBufferUtil.bytes("val");

        Hasher hasher1 = HashingUtils.CURRENT_HASH_FUNCTION.newHasher();
        Hasher hasher2 = HashingUtils.CURRENT_HASH_FUNCTION.newHasher();

        CounterContext.ContextState state = CounterContext.ContextState.allocate(0, 2, 2);
        state.writeRemote(CounterId.fromInt(1), 4L, 4L);
        state.writeLocal(CounterId.fromInt(2), 4L, 4L);
        state.writeRemote(CounterId.fromInt(3), 4L, 4L);
        state.writeLocal(CounterId.fromInt(4), 4L, 4L);

        Cell original = createCounterCellFromContext(cfs, col, state, 5);

        ColumnMetadata cDef = cfs.metadata().getColumn(col);
        Cell cleared = BufferCell.live(cDef, 5, CounterContext.instance().clearAllLocal(state.context));

        original.digest(hasher1);
        cleared.digest(hasher2);

        Assert.assertEquals(hasher1.hash(), hasher2.hash());
    }

