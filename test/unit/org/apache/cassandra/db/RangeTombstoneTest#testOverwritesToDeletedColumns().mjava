    @Test
    public void testOverwritesToDeletedColumns() throws Exception
    {
        Keyspace table = Keyspace.open(KSNAME);
        ColumnFamilyStore cfs = table.getColumnFamilyStore(CFNAME);
        ByteBuffer key = ByteBufferUtil.bytes("k6");
        ByteBuffer indexedColumnName = ByteBufferUtil.bytes(1);

        cfs.truncateBlocking();
        cfs.disableAutoCompaction();
        cfs.setCompactionStrategyClass(SizeTieredCompactionStrategy.class.getCanonicalName());
        if (cfs.indexManager.getIndexForColumn(indexedColumnName) == null)
        {
            ColumnDefinition cd = new ColumnDefinition(indexedColumnName,
                    cfs.getComparator(),
                    IndexType.CUSTOM,
                    ImmutableMap.of(SecondaryIndex.CUSTOM_INDEX_OPTION_NAME, TestIndex.class.getName()),
                    "test_index",
                    0,
                    null);
            cfs.indexManager.addIndexedColumn(cd);
        }

        TestIndex index = ((TestIndex)cfs.indexManager.getIndexForColumn(indexedColumnName));
        index.resetCounts();

        RowMutation rm = new RowMutation(KSNAME, key);
        add(rm, 1, 0);
        rm.apply();

        // add a RT which hides the column we just inserted
        rm = new RowMutation(KSNAME, key);
        ColumnFamily cf = rm.addOrGet(CFNAME);
        delete(cf, 0, 1, 1);
        rm.apply();

        // now re-insert that column
        rm = new RowMutation(KSNAME, key);
        add(rm, 1, 2);
        rm.apply();

        cfs.forceBlockingFlush();

        // We should have 2 updates to the indexed "1" column
        assertEquals(2, index.inserts.size());

        CompactionManager.instance.performMaximal(cfs);

        // verify that the "1" indexed column removed from the index
        // only once, by the re-indexing caused by the second insertion.
        // This second write deletes from the 2i because the original column
        // was still in the main cf's memtable (shadowed by the RT). One
        // thing we're checking for here is that there wasn't an additional,
        // bogus delete issued to the 2i (CASSANDRA-6517)
        assertEquals(1, index.deletes.size());
    }

