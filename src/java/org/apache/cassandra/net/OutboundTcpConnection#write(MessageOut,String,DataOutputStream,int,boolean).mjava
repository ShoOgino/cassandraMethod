    public static void write(MessageOut message, String id, DataOutputStream out, int version, boolean compressionEnabled) throws IOException
    {
        /*
         Setting up the protocol header. This is 4 bytes long
         represented as an integer. The first 2 bits indicate
         the serializer type. The 3rd bit indicates if compression
         is turned on or off. It is turned off by default. The 4th
         bit indicates if we are in streaming mode. It is turned off
         by default. The 5th-8th bits are reserved for future use.
         The next 8 bits indicate a version number. Remaining 15 bits
         are not used currently.
        */
        int header = 0;
        // Setting up the serializer bit
        header |= MessagingService.serializerType.ordinal();
        // set compression bit.
        if (compressionEnabled)
            header |= 4;
        // Setting up the version bit
        header |= (version << 8);

        out.writeInt(MessagingService.PROTOCOL_MAGIC);
        out.writeInt(header);

        // 0.8 included a total message size int.  1.0 doesn't need it but expects it to be there.
        if (version <= MessagingService.VERSION_11)
            out.writeInt(-1);

        out.writeUTF(id);
        message.serialize(out, version);
    }

