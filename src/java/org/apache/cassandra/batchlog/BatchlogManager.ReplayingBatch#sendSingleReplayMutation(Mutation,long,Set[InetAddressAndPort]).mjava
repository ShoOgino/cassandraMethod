        /**
         * We try to deliver the mutations to the replicas ourselves if they are alive and only resort to writing hints
         * when a replica is down or a write request times out.
         *
         * @return direct delivery handler to wait on or null, if no live nodes found
         */
        private static ReplayWriteResponseHandler<Mutation> sendSingleReplayMutation(final Mutation mutation,
                                                                                     long writtenAt,
                                                                                     Set<InetAddressAndPort> hintedNodes)
        {
            String ks = mutation.getKeyspaceName();
            Keyspace keyspace = Keyspace.open(ks);
            Token tk = mutation.key().getToken();

            EndpointsForToken replicas = StorageService.instance.getNaturalAndPendingReplicasForToken(ks, tk);
            Replicas.temporaryAssertFull(replicas); // TODO in CASSANDRA-14549

            EndpointsForToken.Builder liveReplicasBuilder = EndpointsForToken.builder(tk);
            for (Replica replica : replicas)
            {
                if (replica.isLocal())
                {
                    mutation.apply();
                }
                else if (FailureDetector.instance.isAlive(replica.endpoint()))
                {
                    liveReplicasBuilder.add(replica); // will try delivering directly instead of writing a hint.
                }
                else
                {
                    hintedNodes.add(replica.endpoint());
                    HintsService.instance.write(StorageService.instance.getHostIdForEndpoint(replica.endpoint()),
                                                Hint.create(mutation, writtenAt));
                }
            }

            EndpointsForToken liveReplicas = liveReplicasBuilder.build();
            if (liveReplicas.isEmpty())
                return null;

            Replicas.temporaryAssertFull(liveReplicas);
            ReplayWriteResponseHandler<Mutation> handler = new ReplayWriteResponseHandler<>(keyspace, liveReplicas, System.nanoTime());
            MessageOut<Mutation> message = mutation.createMessage();
            for (Replica replica : liveReplicas)
                MessagingService.instance().sendWriteRR(message, replica, handler, false);
            return handler;
        }

