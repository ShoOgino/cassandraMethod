        private boolean collectionAppliesTo(CollectionType type, ColumnNameBuilder rowPrefix, ColumnFamily current, final long now) throws InvalidRequestException
        {
            ColumnNameBuilder collectionPrefix = copyOrUpdatePrefix(current.metadata(), rowPrefix).add(column.name.key);
            // We are testing for collection equality, so we need to have the expected values *and* only those.
            ColumnSlice[] collectionSlice = new ColumnSlice[]{ new ColumnSlice(collectionPrefix.build(), collectionPrefix.buildAsEndOfRange()) };
            // Filter live columns, this makes things simpler afterwards
            Iterator<Column> iter = Iterators.filter(current.iterator(collectionSlice), new Predicate<Column>()
            {
                public boolean apply(Column c)
                {
                    // we only care about live columns
                    return c.isLive(now);
                }
            });

            Term.Terminal v = value.bind(variables);
            if (v == null)
                return !iter.hasNext();

            switch (type.kind)
            {
                case LIST: return listAppliesTo(current.metadata(), iter, ((Lists.Value)v).elements);
                case SET: return setAppliesTo(current.metadata(), iter, ((Sets.Value)v).elements);
                case MAP: return mapAppliesTo(current.metadata(), iter, ((Maps.Value)v).map);
            }
            throw new AssertionError();
        }

