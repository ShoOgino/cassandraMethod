    @Test
    public void decode_HappyPathThrowsException() throws Exception
    {
        callbackHandler.failOnCallback = true;
        buf = new SecondHandshakeMessage(MESSAGING_VERSION).encode(PooledByteBufAllocator.DEFAULT);
        channel.writeInbound(buf);
        Assert.assertFalse(channel.isOpen());
        Assert.assertEquals(1, channel.outboundMessages().size());
        Assert.assertTrue(channel.releaseOutbound()); // throw away any responses from decode()

        Assert.assertEquals(UNKNOWN_PROTOCOL_VERSION, callbackHandler.result.negotiatedMessagingVersion);
        Assert.assertEquals(HandshakeResult.Outcome.NEGOTIATION_FAILURE, callbackHandler.result.outcome);
    }

